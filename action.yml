name: 'Build Jekyll for GitHub Pages'
description: 'A GitHub Action for producing Jekyll build artifacts compatible with GitHub Pages'
author: 'GitHub'
inputs:
  source:
    description: 'Directory where the source files reside.'
    required: false
    default: ./
  destination:
    description: 'Output directory of the build. Although it can be nested inside the source, it cannot be the same as the source directory.'
    required: false
    default: ./_site
  future:
    description: 'Publishes posts with a future date. When set to true, the build is made with the --future option which overrides the future option that may be set in a Jekyll configuration file.'
    required: false
    default: false
  build_revision:
    description: 'The SHA-1 of the git commit for which the build is running. Default to GITHUB_SHA.'
    required: false
    default: ${{ github.sha }}
  verbose:
    description: 'Verbose output'
    required: false
    default: true
  token:
    description: 'GitHub token'
    required: true
    default: ${{ github.token }}
  image_version:
    description: 'Version tag of the actions/jekyll-build-pages Docker image to use.'
    required: true
    default: v1.0.7
runs:
  using: composite
  steps:
    - name: Compare important env vars
      shell: sh
      env:
        GITHUB_ACTION_REF_EXP: ${{ github.action_ref }}
        GITHUB_ACTION_REF: ${{ github.action_ref }}
        GITHUB_ACTION_REPOSITORY_EXP: ${{ github.action_repository }}
        GITHUB_ACTION_REPOSITORY: ${{ github.action_repository }}
      run: |
        echo "github.action_ref = ${{ github.action_ref }}"
        echo "GITHUB_ACTION_REF_EXP = $GITHUB_ACTION_REF_EXP"
        echo "GITHUB_ACTION_REF = $GITHUB_ACTION_REF"
        echo "github.action_repository = ${{ github.action_repository }}"
        echo "GITHUB_ACTION_REPOSITORY_EXP = $GITHUB_ACTION_REPOSITORY_EXP"
        echo "GITHUB_ACTION_REPOSITORY = $GITHUB_ACTION_REPOSITORY"

    - name: Check GHCR status
      id: ghcr
      shell: sh
      env:
        GHCR_STATUS: down
      # using an internal endpoint would be better than status page
      # but this is an acceptable starting point
      run: |
        if [ -z "$GHCR_STATUS" ]; then
          packagesStatus=$(curl -LSs https://www.githubstatus.com/api/v2/components.json | jq -r '.components[] | select(.name == "Packages") | .status')
          echo status=$packagesStatus >> $GITHUB_OUTPUT
        else
          echo status=$GHCR_STATUS >> $GITHUB_OUTPUT
        fi

    - name: Create reusable values
      id: docker
      shell: bash
      env:
        DOCKER_REGISTRY: ghcr.io
        # Docker container does NOT need INPUT_IMAGE_NAME so let's divert with its name
        TAG_NAME: ${{ inputs.image_version }}
        # Do we need to manually build the Docker image?
        MUST_BUILD: ${{ steps.ghcr.outputs.status != 'operational' }}
        # "If the action is written using a composite, then it will not automatically get INPUT_<VARIABLE_NAME>."
        # Ergo, these must be manually created here using `inputs` references.
        INPUT_SOURCE: ${{ inputs.source }}
        INPUT_DESTINATION: ${{ inputs.destination }}
        INPUT_FUTURE: ${{ inputs.future }}
        INPUT_BUILD_REVISION: ${{ inputs.build_revision }}
        INPUT_VERBOSE: ${{ inputs.verbose }}
        INPUT_TOKEN: ${{ inputs.token }}
      run: |
        CLEAN_TAG_NAME=$(echo "${TAG_NAME}" | sed 's/[^a-zA-Z0-9._-].*$//g')
        DOCKER_IMAGE_URL="${DOCKER_REGISTRY}/actions/jekyll-build-pages:${CLEAN_TAG_NAME}"

        # Modeled after: https://github.com/actions/runner/blob/1ceb1a67f270537fe80da23445fa78bfb97503ea/src/Runner.Worker/Container/ContainerInfo.cs#L37
        # example: ghcrioactionsjekyllbuildpagesv107_7ca21f
        DOCKER_CONTAINER_BASENAME=$(echo "${DOCKER_IMAGE_URL}" | sed 's/[^a-zA-Z0-9]//g')
        NEW_GUID=$(uuidgen)
        DOCKER_CONTAINER_NAME="${DOCKER_CONTAINER_BASENAME}_${NEW_GUID:0:6}"

        # actions/runner source: https://github.com/actions/runner/blob/0484afeec71b612022e35ba80e5fe98a99cd0be8/src/Runner.Worker/Container/DockerCommandManager.cs#L49
        # actions/runner example: 6c0442
        # However, here, we're generating a SHA from the workflow run information
        # instead of trying to figure out the equivalent directory path
        LABEL_BASE="${GITHUB_RUN_ID}/${GITHUB_RUN_NUMBER}/${GITHUB_JOB}"
        LABEL_SHA=$(echo "${LABEL_BASE}" | shasum -a 256 | awk '{print $1}')
        DOCKER_CONTAINER_LABEL="${LABEL_SHA:0:6}"

        # Craft an expected image name in case we need to do the local build
        DOCKER_IMAGE_NAME=$DOCKER_IMAGE_URL
        if [[ "$MUST_BUILD" == "true" ]]; then
          DOCKER_IMAGE_NAME="${DOCKER_CONTAINER_LABEL}:$(uuidgen)"
        fi

        # actions/runner source: https://github.com/actions/runner/blob/0484afeec71b612022e35ba80e5fe98a99cd0be8/src/Runner.Worker/Container/DockerCommandManager.cs#L130-L140
        # Gather list of environment variable names starting with GITHUB_
        GITHUB_ENV_VARS=$(env | while IFS= read -r line; do key=${line%%=*}; if [[ "$key" =~ ^GITHUB_.+$ ]]; then printf -- '-e %s ' "$key"; fi; done)
        # Gather list of environment variable names starting with ACTIONS_
        ACTIONS_ENV_VARS=$(env | while IFS= read -r line; do key=${line%%=*}; if [[ "$key" =~ ^ACTIONS_.+$ ]]; then printf -- '-e %s ' "$key"; fi; done)
        # Gather list of environment variable names with values starting with INPUT_
        INPUT_ENV_VARS=$(env | while IFS= read -r line; do key=${line%%=*}; val=${line#*=}; if [[ "$key" =~ ^INPUT_.+$ ]]; then printf -- '-e %s=%s ' "$key" "$val"; fi; done)
        PASSTHROUGH_ENV_VARS="${GITHUB_ENV_VARS}${ACTIONS_ENV_VARS}${INPUT_ENV_VARS}"

        echo "registry=${DOCKER_REGISTRY}" >> $GITHUB_OUTPUT
        echo "image_url=${DOCKER_IMAGE_URL}" >> $GITHUB_OUTPUT
        echo "image_name=${DOCKER_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "container_name=${DOCKER_CONTAINER_NAME}" >> $GITHUB_OUTPUT
        echo "container_label=${DOCKER_CONTAINER_LABEL}" >> $GITHUB_OUTPUT
        echo "env_expansion=${PASSTHROUGH_ENV_VARS}" >> $GITHUB_OUTPUT

    - if: ${{ steps.ghcr.outputs.status == 'operational' }}
      name: Login to GHCR
      shell: sh
      env:
        DOCKER_REGISTRY: ${{ steps.docker.outputs.registry }}
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        echo $GITHUB_TOKEN | docker login $DOCKER_REGISTRY -u $GITHUB_ACTOR --password-stdin

    - if: ${{ steps.ghcr.outputs.status == 'operational' }}
      name: Pull prebuilt Docker image
      shell: sh
      env:
        DOCKER_IMAGE_URL: ${{ steps.docker.outputs.image_url }}
      run: |
        docker pull $DOCKER_IMAGE_URL

    - if: ${{ steps.ghcr.outputs.status != 'operational' }}
      name: Build local Docker image
      shell: sh
      env:
        DOCKER_IMAGE_NAME: ${{ steps.docker.outputs.image_name }}
      run: |
        # Manually change directory given bug with github.action_path reference
        # Issue: https://github.com/actions/runner/issues/716
        # Pending PR: https://github.com/actions/runner/pull/2517
        cd $GITHUB_ACTION_PATH
        # NOTE: This will rely on DockerHub to pull the ruby-slim image
        docker build -t $DOCKER_IMAGE_NAME -f Dockerfile .

    - name: Run task in Docker container
      shell: sh
      env:
        DOCKER_CONTAINER_NAME: ${{ steps.docker.outputs.container_name }}
        DOCKER_CONTAINER_LABEL: ${{ steps.docker.outputs.container_label }}
        DOCKER_IMAGE_NAME: ${{ steps.docker.outputs.image_name }}
      run: |
        docker run \
          --name $DOCKER_CONTAINER_NAME \
          --label $DOCKER_CONTAINER_LABEL \
          --workdir /github/workspace \
          --rm \
          ${{ steps.docker.outputs.env_expansion }} \
          -e HOME \
          -e GITHUB_ACTIONS=true \
          -e CI=true \
          -v "/var/run/docker.sock":"/var/run/docker.sock" \
          -v "$RUNNER_TEMP/_github_home":"/github/home" \
          -v "$RUNNER_TEMP/_github_workflow":"/github/workflow" \
          -v "$RUNNER_TEMP/_runner_file_commands":"/github/file_commands" \
          -v "$GITHUB_WORKSPACE":"/github/workspace" \
          $DOCKER_IMAGE_NAME
